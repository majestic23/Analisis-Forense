# Yara Rules

Yara significa  Yara (_Yet Another Ridiculous Acronym_)

_"The pattern matching swiss knife for malware researchers (and everyone else)" ([Virustotal., 2020](https://virustotal.github.io/yara/))_

Es una herramienta usada para identificar un archivo basado en patrones binarios o textuales.

Sus reglas consisten en un conjunto de strings y condiciones que determinan su lógica.

*`Tu regla solo será efectiva tanto como tu entiendas el patron que deseas usar para su busqueda.`*

Se compilan con yarac para incrementar la velocidad del escaneo y la utilización de múltiples escaneos.

2 argumentos necesarios 
a) El archivo regla a crear.
b) Nombre del archivo, directorio, o numero de proceso que la regla usará.

*Siempre debe haber un nombre y una condición*

Todas las reglas se crean bajo extension .yar

# Estructura:

![[Images/Pasted image 20221226123120.png]]

## 1. Modulos

Lo modulos de Yara te permiten extender la funcionalidad de las reglas, dentro de los más usados tenemos el módulo PE


## 2. Nombre

Toda regla debe tener un nombre que la identifique y pueda utilizarse

## 3. Metadata

La metadata no afecta lo que buscará la regla YARA, sino que proporcionan información útil sobre la regla en sí.

- Autor: nombre, dirección de correo electrónico, identificador de Twitter.
- Fecha: fecha en que se creó la regla.
- Versión: el número de versión de la regla YARA para el seguimiento de las enmiendas.
- Referencia: un enlace a un artículo o descarga de la muestra, se utiliza para proporcionar información relevante sobre la muestra de malware que la regla está diseñada para detectar.
- Descripción: una breve descripción general del propósito de la regla y el malware que pretende detectar.
- Hash: una lista de hash de muestra que se usaron para crear la regla YARA.

![image](https://user-images.githubusercontent.com/28854110/209840367-2dd4ff80-fe7f-4d4f-a142-134adea75dd5.png)


## 4. Strings

-  Las cadenas de texto son case sensitive.
-  Se puede utilizar case insensitive con la opcion `nocase`
-  El modificador `wide` se puede usar para el formato UTF-16 PERO no es compatible con UTF-16.
-  El modificador `ascii` se puede usar para el encodeado ASCII por defecto.
-  El condicional `xor`  puede ser usado para la busqueda de cadenas con solo un único byte xor aplicado en el.
-  Puedes combinar todos los tipos. E.g. `ascii wide nocase xor`.
-  Puedes escribir `xor (0x01-0xff)` para un rango específico de xor bytes en lugar de todos los 255.
-  El modificador `fullword` garantiza que la cadena coincidirá solo si aparece en el archivo delimitada por caracteres no alfanuméricos
-  Usa la palabra clave `fullword`  cuando el string sea corto

#### Cadenas Hexadecimales (Hex Strings)
Las cadenas hexadecimales permiten tres construcciones especiales que las hacen más flexibles: comodines, saltos y alternativas.


![image](https://user-images.githubusercontent.com/28854110/209840403-2e9cd439-caf1-479d-a6ae-3cb5d28cf998.png)


## 5. Condiciones

Las condiciones no son más que expresiones booleanas como las que se pueden encontrar en todos los lenguajes de programación, por ejemplo en una sentencia if. Pueden contener los típicos operadores booleanos `y`, `o` y `no`, y los operadores relacionales `>=`, `<=`, `<`, `>`, `==` y `!=` . Además, los operadores aritméticos (`+`, `-`, `*`, `\`, `%`) y operadores bit a bit (`&`, `|`, `<<`, `>>`, `~ `, `^`) se puede utilizar en expresiones numéricas.


```bash
# Ejemplo de condicion yara
condition:  
($a or $b) and ($c or $d)//$a,$b,$c,$d 
```

Revisar documentacion oficial sobre condiciones de yara:
https://yara.readthedocs.io/en/stable/writingrules.html#conditions


# Walkthrough

En esta ocasión crearemos una regla de yara visualizando sus strings y de manera automatizada con yargen 

Primero empezaremos utilizando una plantilla base para la escritura de la regla que usaremos:

```json
rule specifc_name       // e.g. APT_CN_Winnti_exploit or crimeware_ZZ_RAT
{
    meta:               // suggested
        author = 
        date_created = 
        date_last_modified = 
        description = 
        filetype = 
        hash = 
        hash = 
        source = 
        TLP = 
        license = 
        min_yara_version = 
    
    strings:
        $a1 = "string type 1-1" ascii wide fullword nocase
        $a2 = "string type 1-2" 
        $a3 = "string type 1-3"

        $b1 = "string type 2-1"
        $b2 = "string type 2-2"
        $b3 = "string type 2-3"

        $c1 = "string type 3-1"
        $c2 = "string type 3-2"
        $c3 = "string type 3-3"
    
    condition:
        any of $a* or (2 of $b*) or (1 of $c*)
}
```


A partir de acá empezaremos eligiendo el malware que analizaremos en todo el laboratorio, un buen recurso para obtener algunas muestras es el repositorio github __thezoo__ en el cual podremos encontrar.

En esta ocasion utilizaremos la muestra del ransomware LOKI

![[Pasted image 20221226131406.png]]

Link de descarga directa: 
https://github.com/ytisf/theZoo/raw/master/malware/Binaries/Ransomware.Locky/Ransomware.Locky.zip

*Password: infected*

Como parte del analisis inicial empezaremos extrayendo lo necesario para nuestras condiciones de nuestra regla yara.

### Extracción de strings

Para este proceso utilizaremos la herramienta strings de nuestra máquina kali, de utilizarse windows como sistema operativo se utilizaría su contraparte strings.exe de la suit sysinternals.

Strings por defecto nos mostrará aquellas cadena de texto que tengan un minimo de 4 caracteres, sin embargo para un analisis más profundo nosotros extraeeremos aquellas que tengan 5 a más.


Linux:
```bash
strings -n 5 <nombre del archivo> > strings.txt
```


Una manera más eficaz de realizar este análisis es extraer los strings en base a la cantidad de bytes que esto posean:

```bash
strings -el <nombre del archivo> > strings.txt
```


### YarGen

Yargen es una herramienta creada para automatizar la creación de reglas yara en base a distintos

![image](https://user-images.githubusercontent.com/28854110/209840458-a8cf923d-2533-4a5b-a97e-40cb07cc77a8.png)

Para la creación de nuestra regla para el ransomware Locky utilizaremos la flag `-m ` especificando un directorio a escanear:

```js
python yarGen.py -m /home/sansforensics/Desktop/Volatility/yarGen/Malware/
```


![image](https://user-images.githubusercontent.com/28854110/209840501-1a10a5f4-1de9-4770-8a78-6e3385256124.png)

Observamos que todas las reglan han sido escritas dentro del archivo `yargen_rules.yar`

![image](https://user-images.githubusercontent.com/28854110/209840532-360f791c-a304-465d-9935-76813d9db1c1.png)

En los siguientes resultados obtenemos una regla bastante completa especificamente para el ransomware Locky.

![image](https://user-images.githubusercontent.com/28854110/209840561-f7999e5a-7df8-4811-91c5-6263174106c7.png)

Probaremos nuestra regla con el comando yara:

```bash
yara yargen_rules.yar Malware/
```

![image](https://user-images.githubusercontent.com/28854110/209840583-1e178451-c4d3-40b6-9fb4-9fed8361a869.png)

Como forenses debemos tener en cuenta que esta automatización en el proceso de crear la regla de yara puede completarse con nuestras propias condiciones y nuestros propios analisis.


